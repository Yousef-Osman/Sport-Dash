@model SportDash.ViewModels.MessagingViewModel

@{
    ViewData["Title"] = "Live Chat";
}

<div class="container mb-5">
    <h3 class="mt-3 p-3" style="border-radius: 40px;width: 70%;margin: 20px auto;text-transform: capitalize;padding: 20px;background: #fff;text-align: center;"><a asp-action="Index" asp-controller="Playground" asp-route-id="@Model.EntityId">@Model.CurrentPage</a></h3>
    <div id="msgs-container" class="chat" style="width: 70%;margin: auto;border-radius: 25px;">
        @foreach (var msg in Model.Messages)
        {
            if (msg.Sender.UserName == User.Identity.Name)
            {
                <div class="mine messages" style="margin-bottom: -20px;font-size: 23px;">
                    <span class="sm-msg">@msg.MessageDate</span>
                    <div class="message last" onclick="toggleDate(event)">
                        @msg.Body
                    </div>
                </div>
            }
            else
            {
                <div class="yours messages" style="margin-bottom: -20px;font-size: 23px;">
                    <span class="sm-msg">@msg.MessageDate</span>
                    <div class="message last" onclick="toggleDate(event)">                        
                        @msg.Body
                    </div>
                </div>
            }
        }        
    </div>
    <div class="mt-2 form-container" style="display: flex;justify-content: center;">
        <textarea id="msg" onkeypress="sendKey(event)" class="form-control round-borders" style="width: 60%;" placeholder="Write your message here ...."></textarea>
        <button onclick="send()" style="width: 9%" class="round-borders btn-elephant"><img src="~/images/send.png" /><br />Send</button>
    </div>    
</div>

@section Scripts{ 
    <script>
        const msgIn = document.querySelector("#msg");
        msgIn.focus();
        function send() {
            const msgIn = document.querySelector("#msg");
            if (msgIn.value != "") {
                connection.invoke("SendMsg", msgIn.value, location.pathname.split('/')[3]);
                msgIn.value = "";
            }
        }
        function sendKey(event) {            
            if (event.key == "Enter") {
                event.preventDefault();
                send();
            }
        }
        connection.on("recMsg", (msg, sender, date) => {
            const msgContainer = $("#msgs-container");            
            if (sender.id == location.pathname.split('/')[3]) {                
                msgContainer.prepend(`<div style="margin-bottom: -20px;font-size: 23px;" class="yours messages">
                <span class="sm-msg">${date}</span>
                <div class="message last" onclick="toggleDate(event)">
                    ${msg}
                </div>
            </div>`);
            }
            else {
                msgContainer.prepend(`<div style="margin-bottom: -20px;font-size: 23px;" class="mine messages">
                <span class="sm-msg">${date}</span>
                <div class="message last" onclick="toggleDate(event)">
                    ${msg}
                </div>
            </div>`);
            }
        });
        function toggleDate(event)
        {
            var dateEle = event.target.parentElement.children[0];
            if (dateEle.style.display === 'none') {
                dateEle.style.display = 'block';
            }
            else {
                dateEle.style.display = 'none';
            }
        }
    </script>
}